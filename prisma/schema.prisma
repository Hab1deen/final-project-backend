generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ตารางผู้ใช้งาน
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String
  role      String   @default("user") // user, admin
  
  // Email Verification
  isEmailVerified Boolean  @default(false)
  emailVerifiedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  receipts  Receipt[] // ความสัมพันธ์กับใบเสร็จ (ผู้ออกใบเสร็จ)
  signatureTemplates SignatureTemplate[] // เทมเพลตลายเซ็น
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens PasswordResetToken[]
  loginHistory LoginHistory[]

  @@map("users")
}

// ตารางลูกค้า
model Customer {
  id        Int      @id @default(autoincrement())
  name      String
  email     String?
  phone     String?
  address   String?
  taxId     String? // เลขประจำตัวผู้เสียภาษี
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  quotations Quotation[]
  invoices   Invoice[]

  @@map("customers")
}

// ตารางสินค้า/บริการ
model Product {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  price       Decimal  @db.Decimal(10, 2)
  unit        String   @default("ชิ้น")
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  quotationItems QuotationItem[]
  invoiceItems   InvoiceItem[]

  @@map("products")
}

// ตารางใบเสนอราคา
model Quotation {
  id              Int      @id @default(autoincrement())
  quotationNo     String   @unique
  customerId      Int?
  customerName    String
  customerPhone   String?
  customerAddress String?

  subtotal Decimal @db.Decimal(10, 2)
  discount Decimal @default(0) @db.Decimal(10, 2)
  vat      Decimal @default(7) @db.Decimal(5, 2)
  total    Decimal @db.Decimal(10, 2)

  notes      String?
  validUntil DateTime?
  status     String    @default("draft") // draft, sent, accepted, rejected, converted

  // --- [New Features] ---
  siteImages        String?  @db.Text // รูปภาพหน้างาน (Before)
  customerSignature String?  @db.Text // ลายเซ็นลูกค้า (อนุมัติจ้าง)
  
  approvalToken     String?  @unique
  approvalStatus    String   @default("pending") // pending, approved, rejected
  approvedAt        DateTime?
  approvalNotes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer   Customer?            @relation(fields: [customerId], references: [id])
  items      QuotationItem[]
  images     QuotationImage[]
  signatures QuotationSignature[]
  invoice    Invoice?

  @@map("quotations")
}

// ตารางรายการสินค้าในใบเสนอราคา
model QuotationItem {
  id          Int      @id @default(autoincrement())
  quotationId Int
  productId   Int?
  productName String
  description String?
  quantity    Int
  price       Decimal  @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)

  quotation Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  product   Product?  @relation(fields: [productId], references: [id])

  @@map("quotation_items")
}

// ตารางรูปภาพใบเสนอราคา (เผื่อกรณีมีหลายรูป)
model QuotationImage {
  id          Int      @id @default(autoincrement())
  quotationId Int
  imageUrl    String
  caption     String?
  createdAt   DateTime @default(now())

  quotation Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)

  @@map("quotation_images")
}

// ตารางลายเซ็นใบเสนอราคา (เก็บประวัติการเซ็น)
model QuotationSignature {
  id           Int      @id @default(autoincrement())
  quotationId  Int
  type         String   // shop, customer
  signatureUrl String
  signerName   String
  signedAt     DateTime @default(now())

  quotation Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)

  @@map("quotation_signatures")
}

// ตารางใบแจ้งหนี้
model Invoice {
  id              Int      @id @default(autoincrement())
  invoiceNo       String   @unique
  quotationId     Int?     @unique
  customerId      Int?
  customerName    String
  customerPhone   String?
  customerAddress String?

  subtotal Decimal @db.Decimal(10, 2)
  discount Decimal @default(0) @db.Decimal(10, 2)
  vat      Decimal @default(7) @db.Decimal(5, 2)
  total    Decimal @db.Decimal(10, 2)

  paidAmount      Decimal @default(0) @db.Decimal(10, 2)
  remainingAmount Decimal @db.Decimal(10, 2)

  status   String    @default("unpaid") // unpaid, partial, paid, overdue
  dueDate  DateTime?
  paidDate DateTime?

  notes String?

  // --- [New Features] ---
  workImages          String?  @db.Text // รูปภาพผลงาน (After)
  acceptanceSignature String?  @db.Text // ลายเซ็นรับงาน (ลูกค้าเซ็นรับ)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer     Customer?          @relation(fields: [customerId], references: [id])
  quotation    Quotation?         @relation(fields: [quotationId], references: [id])
  items        InvoiceItem[]
  images       InvoiceImage[]
  signatures   InvoiceSignature[]
  payments     Payment[]
  appointments Appointment[]
  receipts     Receipt[]

  @@map("invoices")
}

// ตารางรายการสินค้าในใบแจ้งหนี้
model InvoiceItem {
  id          Int      @id @default(autoincrement())
  invoiceId   Int
  productId   Int?
  productName String
  description String?
  quantity    Int
  price       Decimal  @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)

  invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])

  @@map("invoice_items")
}

// ตารางรูปภาพใบแจ้งหนี้
model InvoiceImage {
  id        Int      @id @default(autoincrement())
  invoiceId Int
  imageUrl  String
  caption   String?
  createdAt DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_images")
}

// ตารางลายเซ็นใบแจ้งหนี้
model InvoiceSignature {
  id           Int      @id @default(autoincrement())
  invoiceId    Int
  type         String   // shop, customer
  signatureUrl String
  signerName   String
  signedAt     DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_signatures")
}

// ตารางการชำระเงิน (ประวัติการจ่าย)
model Payment {
  id            Int      @id @default(autoincrement())
  invoiceId     Int
  amount        Decimal  @db.Decimal(10, 2)
  paymentDate   DateTime @default(now())
  paymentMethod String   @default("cash") // cash, transfer, credit
  notes         String?
  createdAt     DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("payments")
}

// ตารางนัดหมาย
model Appointment {
  id              Int      @id @default(autoincrement())
  invoiceId       Int?
  title           String
  description     String?
  appointmentDate DateTime
  startTime       String?
  endTime         String?
  appointmentType String   // installation, payment, other
  status          String   @default("pending") // pending, completed, cancelled

  location      String?
  contactPerson String?
  contactPhone  String?

  notes        String?
  reminderSent Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoice Invoice? @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("appointments")
}

// ตารางใบเสร็จรับเงิน
model Receipt {
  id            Int      @id @default(autoincrement())
  receiptNo     String   @unique
  invoiceId     Int
  userId        Int      // ผู้ออกใบเสร็จ
  amount        Decimal  @db.Decimal(10, 2)
  paymentMethod String   // cash, transfer, credit, etc.
  notes         String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  invoice    Invoice            @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  user       User               @relation(fields: [userId], references: [id])
  signatures ReceiptSignature[]

  @@map("receipts")
}

// ตารางลายเซ็นใบเสร็จรับเงิน
model ReceiptSignature {
  id            Int      @id @default(autoincrement())
  receiptId     Int
  signatureData String   // Base64 หรือ URL
  signedBy      String   // ชื่อผู้เซ็น
  signedAt      DateTime @default(now())

  receipt Receipt @relation(fields: [receiptId], references: [id], onDelete: Cascade)

  @@map("receipt_signatures")
}

// ตารางเทมเพลตลายเซ็น
model SignatureTemplate {
  id           Int      @id @default(autoincrement())
  userId       Int
  name         String
  signatureUrl String   @db.Text
  isDefault    Boolean  @default(false)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("signature_templates")
}

// ตารางเทมเพลต Token สำหรับยืนยันอีเมล
model EmailVerificationToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_verification_tokens")
}

// ตารางเทมเพลต Token สำหรับรีเซ็ตรหัสผ่าน
model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  usedAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

// ตารางประวัติการเข้าสู่ระบบ
model LoginHistory {
  id            Int      @id @default(autoincrement())
  userId        Int
  ipAddress     String
  userAgent     String   @db.Text
  browser       String?
  os            String?
  device        String?
  location      String?
  loginStatus   String   // success, failed
  failureReason String?
  isNewDevice   Boolean  @default(false)
  createdAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("login_history")
  @@index([userId, createdAt])
}